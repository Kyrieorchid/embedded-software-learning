# 通信协议

## 1. CAN

###### 基本特点

* CAN网络是***多主架构***，任何节点都可以在总线空闲时发送数据，而无需中央控制器。这种结构允许多个设备在总线上平等地通信。
* CAN协议不使用传统的地址方式进行通信，而是基于***消息ID***（Identifier）来标识数据。每个消息帧都包含一个唯一的ID，用于<u>决定消息的优先级和接收节点</u>，消息ID越低，优先级越高。
* 错误检测包括循环冗余校验（CRC）、帧检测、确认错误、位填充等。任何错误都会被检测并自动处理，确保数据传输的可靠性。
* 在同一网络中，所有单元必须设定成统一的通信速度。

###### 消息帧分类

* **数据帧（Data Frame）**

​	  用于传输实际的数据（发送数据）。数据帧的结构包括起始位、仲裁场、控制场、数据场、CRC场、ACK场和结束位。

* **远程帧（Remote Frame）**

​	  用于请求其他节点发送数据（接收数据），与数据帧类似，但没有数据字段，数据长度码以请求发送的数据长度表示。

* **错误帧（Error Frame）**

  当检测到通信错误时，节点会发送错误帧以通知总线上的其他节点。6位连续（主动错误显性、被动错误隐性）错误标志+8位连续隐性界定符。

* **过载帧（Overload Frame）**

  用于处理由于延迟或内部缓冲区未准备好而引起的超载情况。过载帧由过载标志（6个位的显性位）和过载界定符(8个位的隐性位)构成，连续6个显性位可以<u>打断其他节点继续发送帧</u>，从而防止过载。

###### 帧详细结构

* **起始位（Start of Frame, SOF）**：一个显性位，表示数据帧的开始。

* **仲裁段（Arbitration Field）**：包含报文ID，用于决定消息优先级。线与机制，逐位比较先显性电平的优先级高。

* **控制段（Control Field）**：包括标识符扩展位和数据长度码（DLC）。

* **数据段（Data Field）**：可包含0到8字节的数据，在CAN-FD中可扩展到64字节。**<u>*高位先行*</u>**

* **CRC段（CRC Field）**：用于错误检测的循环冗余校验码，15位CRC序列和1位分隔符。计算范围包括<u>帧起始、仲裁段、控制段和数据段</u>。

* **ACK段（ACK Field）**：包括Slot和分节符，接收节点用来确认成功接收到消息。发送单元发送隐性，接收到正常消息的节点发送显性。

* **结束位（End of Frame, EOF）**：7个隐性位，表示数据帧的结束。

* **帧间隔**：连续3个隐性位，用于分隔数据帧和遥控帧的帧。过载帧和错误帧前不能插入帧间隔。

###### CAN的工作原理

1. **仲裁机制（非破坏性制裁、线与机制）**：

- 当多个节点同时尝试在总线上发送数据时，它们会根据消息ID的优先级进行仲裁。每个节点<u>在发送数据的过程中不断监控总线上的信号</u>。如果某个节点发现自己发送的ID的某个位在总线上与期望的不符，它就会停止发送，因为另一个具有更高优先级的节点正在发送数据。这样，<u>只有优先级最高的节点可以成功发送其消息</u>。

2. **错误检测**：

- CAN协议通过多种方式进行错误检测，包括位监控、位填充、CRC校验、帧校验和确认检查。当检测到错误时，<u>发送错误帧来通知其他节点，并尝试重新发送数据</u>。错误状态分为主动错误状态，被动错误状态和总线关闭态3种状态，根据发送错误和接收错误计数值来决定进入何种状态。
- 位错误、填充错误、格式错误、ACK错误：在错误产生的那一位的下一位开始发送错误帧。
- CRC错误：紧随ACK界定符后的位发送错误帧。  

3. **消息过滤**：

- 每个节点可以<u>根据消息ID过滤</u>接收的数据，只处理相关的消息，减少不必要的数据处理。

4. **CAN_FIFO & MailBox**
- FIFO在配置好接受滤波器后，所有通过滤波的消息会顺序存储在缓冲区，只能按照先进先出来处理；MB可以配置为收发特定ID的消息，还可以根据ID手动配置优先级，不必按顺序处理。
- FIFO适用于处理大量顺序性强、优先级要求不高的普通消息，而邮箱更适用于对消息有严格控制需求的场景，如需要优先处理的关键消息。

***

[参考](https://zhuanlan.zhihu.com/p/162708070)
[参考](https://zhuanlan.zhihu.com/p/677658199)

## 2. LIN

 * LIN（Local Interconnect Network）是CAN（Controller Area Network）的补充。

 * 单数据线串行通信，通常用UART接口通信（***接口*** & ***协议***），低成本、简单、低速。多用于车门、车窗、车灯等控制。

 * 主从架构：一个主节点和若干从节点（一般最多15个），主节点调度和控制通信，从节点被动响应主节点的命令。

 * 同步机制：通过同步字段（Sync Field）和标识符字段（Identifier Field）来实现节点的同步。

   <img src="https://pic2.zhimg.com/v2-99ab1663773aab1178888fc4d7165d3d_r.jpg" alt="img" style="zoom:50%;" />

   ***

   ##### 帧结构

   <img src="https://pic4.zhimg.com/v2-acabef5c62959abaccb9ea881b5c3887_r.jpg" alt="img" style="zoom:50%;" />

    1. **Break同步间隔字段**：用于指示帧的开始，由主节点发送，用于唤醒从节点并同步通信。Break段至少13位显性电平和至少1位隐性间隔符（总共14bit）。

    2. **Sync同步字段**：用于同步从节点的波特率，通常为0x55（01010101b）；主机时钟精度要高。

       ​	**Tips：字节域（Byte Field）**：1位显性起始位+8位data+1位隐性停止位（”显开隐走“），是一种标准的UART传输格式。在Lin的一帧中除Break段外都是以ByteField传输的，低位先行。

       <img src="https://pic3.zhimg.com/v2-10db3a69fec2fadf942c9fa6d17f259a_r.jpg" alt="img" style="zoom:50%;" />

       有：	`传输1位时间 = (第7位下降沿 - 起始位下降沿) / 8`

       即主节点位速率，从节点计算出用来同步自身速率。

       

    3. **Protected Identifier受保护ID字段（8位PID）**：包含帧的类别和目的地，包括6位帧ID和2位奇偶校验位。

       <img src="https://pic3.zhimg.com/v2-e3541718b5d77ff994552c06df0e55e6_r.jpg" alt="img" style="zoom:50%;" />

       帧ID取值范围0x00~0x3F，共64个，从机根据该ID做出反应（接收/发送/忽略）。校验位如下：

       <img src="https://pic1.zhimg.com/v2-d638af4335e6f7358708fd2f82c1391c_r.jpg" alt="img" style="zoom:50%;" />

       由于异或运算，PID段不会出现全0或全1，若从节点收到0xFF、0x00则传输错误。

       

    4. **数据字段**：包含实际传输的数据，长度为1到8字节（常用（2、4）8字节），两种数据类型：信号和诊断消息。Lin并没有规定数据长度的信息，需要提前设定。

    5. **校验字段**：用于错误检测，采用经典校验和（Checksum）算法。

   ***

    LIN通信中，break字段通常为连续至少13位低电平，用于标识帧的开始、唤醒从节点。从节点需要能够检测和解析到break字段，但通常<u>不需要特别配置从节点break字段长度</u>，其硬件和驱动程序能够检测和响应标准的break字段。

​	[参考](https://www.zhihu.com/search?type=content&q=lin%E5%8D%8F%E8%AE%AE)



## 3. SENT

##### 概述
​* 单边半字节传输（Single Edge Nibble Transmission），点对点、单向传输。
* 无需接收器和集成发射器，因此相比CAN或Lin成本更低，且具有不错的传输精度和速度，数字数据传输速度可达30kb/s。
* 单线数据传输，减少信号线，加上电源和地线，总共3线；单向传输，数据只能从传感器到ECU，传输是连续的，不需要请求命令。
* 由帧来传输数据，或者数据包的形式，每一帧由不同宽度的脉冲即半字节组成，数据的传输可以分为快速通道和慢速通道，重要的信号用快速通道以实现高频率的更新，比如压力等，对于非关键的信号，如诊断等可以放在慢速通道传输（<b>快速通道是每一帧传输一个完整的信号，慢速通道需要多帧来传输一个完整的信号</b>，即更新频率不同）。
##### 信号帧
1. 同步脉冲
  指示一帧的开始，以一个下降沿开始，到下一个下降沿结束，间隔56个clock ticks。
2. 状态和通信信息
  包含传感器状态和通信附加信息，<u>1个nibble（4bits，12~27ticks）</u>。
3. 数据nibbles
  连续6个（1~8个）nibbles的data pulses。
4. CRC
  1个nibble。
5. 可选的pause pulse。
##### nibble & ticks 时间编码 & S(hort)P(WM)C(ode)
1个nibble即4bits，用12~27个ticks表示。
|ticks | nibble|
| ---- | ----  |
|12    |  0000 |
|13    |  0001 |
|n     |(n-12)~b~|
|27    |  1111 |

<u>在SENT中以tick的多少、即脉冲的宽度表示数据与状态、即PWM，在SENT中称SPC编码。</u>
`同步段(56ticks) + 状态信息段(12~27ticks) + 数据(12~216ticks) + CRC(12~27ticks) + 可选暂停(12~768ticks) == 92~1094ticks`

sent传输时有一时钟计时每个脉冲所占用的时间，例如同步段脉冲耗时840us，则`1tick = 840 / 56 == 15us`，采用此时间编码的数字传输方式，有更高抗干扰性。
##### 慢速通道传输
慢速通道的数据嵌入在每个快速通道帧的<u>状态和通信信息段中的特定位</u>上，接收端需要接收多个快速通道帧来重建完整的慢速通道数据。

[参考](https://blog.csdn.net/liugaoxingliushi/article/details/122913797)

## 4. ETH

​	

## 5. I2C

##### 概述
* <u>SDA数据线和SCL时钟线</u>，串行同步半双工，高位先行。
* 多主多从模式，主机负责生成时钟信号并控制通信开始和结束（主机在接收时也由主机产生start/stop）。
* 每个设备在总线上有唯一的地址，通常为7位或10位。
* 以<u>字节</u>为单位传输。
* 接收设备接收到每个字节后会发送<u>应答</u>。
* SDA&SCL都为开漏输出，只能输出低电平，通过上拉电阻弱上拉，空闲状态都为高。
* 工作原理：
  1. <u>SDA下降沿</u>表示通信开始。
  2. 主机发送从机的地址以及一个读/写位，指定对某一从机进行读/写（0或1不固定）。
  3. 以字节为单位传输，每字节后发送应答信号。
  4. <u>SDA上升沿</u>表示通信结束（或重新产生开始信号继续传输）。
  5. <b>SDA的数据信号只有在SCL拉低时才能变化，所以SCL拉低时SDA的拉低或拉高用来表示开始或结束。</b>

##### ACK & NACK
  在SCL每个脉冲期间SDA只能传输一个数据位，则传输一个字节需要8个SCL时钟周期，在传输结束后，还有一个来自接收方的应答时钟周期，若SDA在应答周期被拉低，则为ACK，<u>在读取了本次数据后，如果不继续读取，则发送NACK。</u>

##### 读写时序
  * 写：
  ||||||||||||
  |-|-|-|-|-|-|-|-|-|-|-|
  |主机|start|从机地址+W||寄存器地址||待写入数据||待写入数据||stop|
  |从机|||ACK||ACK||ACK||ACK||

  * <b>读</b>：
  |||||||||||||||
  |-|-|-|-|-|-|-|-|-|-|-|-|-|-|
  |主机|start|从机地址+W||寄存器地址||start|从机地址+R|||ACK||NACK|stop|
  |从机|||ACK||ACK|||ACK|发送数据||发送数据|||

  <u>哑写（Dummy Write）</u>：
  指主设备向从设备发送一个写命令，但不实际发送有意义的数据。主要目的是为了设置从设备的寄存器地址或触发其他某些操作（如更新值），而不关注发送的数据内容。
  在IIC读时序中，主机发送`从机地址+写命令+寄存器地址`，<u>将从机内部寄存器指针指向要读数据的寄存器</u>，然后发送`restart+从机地址+读命令`，确保正确读。

##### 参考
  硬件、仲裁等细节，(UM10204 I2C-bus specification and user manual)[参考](https://zhuanlan.zhihu.com/p/149364473)
​	

## 6. I2S

##### 概述
* Inter-IC Sound，数字音频传输串行接口，定义了音频数据传输格式、时序和控制信号。
* Rx方向：麦克风在机械振动下将声音信号转变为电压信号，电压信号经过放大等处理，给到ADC采样，将模拟信号转化为数字信号。
* Tx方向：数字信号经过编码、存储、压缩等技术后，发送给解码器如DAC，将数字信号还原为模拟信号。
​* 音频信号在处理器与A/D Converter之间的传输就是使用的I2S协议。<b>总线仅处理音频数据的传输，因此控制信号和子编码信号需要使用不同的总线协议如I2C传输</b>。

##### 信号线
* 时钟线（Continues Serial Clock，SCK）：提供同步传输时钟信号，也称Bit Clock。`f~SCK~ = 2 x f~sample~ x 位宽`。
* 左/右声道线（Left-Right Clock，LRCK）：LRCK线指示了当前传输的是左声道的音频数据还是右声道的音频数据。它被称为帧同步信号。`f~LRCK~ = f~sample~`。
* 数据线（Serial Data，SD ）：传输实际音频数据，位宽通常为16或32。

##### 工作模式
* 主从模式，时钟信号（SCK）和帧同步信号（LRCK）均由Master提供。
* 三种工作模式
||||
|--|--|--|
|发射器|Master|Slave|
|接收器|Slave |Master/Slave(由系统其他模块提供SCK和LRCK)|

##### 数据传输模式
* Philip标准模式：
  1. LRCK为<u>低</u>，表示<u>左声道</u>；LRCK为高，表示右声道。
  2. SCK下降沿发送数据，上升沿采样数据。
  3. LRCK跳变后delay一个时钟周期再发送有效数据。
  4. 高位先行。MSB与delay的SCK边沿对齐。

* 左对齐（Left Justified）模式，相比于标准模式：
  1. LRCK为<u>高</u>，表示<u>左声道</u>；LRCK为低，表示右声道。
  2. 没有data delay。
  3. MSB与LRCK跳变边沿对齐。(高位先行，MSB在时序图左)。

* 右对齐（Right Justified）模式，相比于标准模式：
  1. LRCK为<u>高</u>，表示<u>左声道</u>；LRCK为低，表示右声道。
  2. 没有data delay。
  3. LSB与LRCK跳变边沿对齐。(高位先行，LSB在时序图右)。

##### 位宽与位深
`f~SCK~ = 2 x f~sample~ x 位宽 = 2 x f~LRCK~ x 位宽`
`位宽 = f~SCK~ / (2 x f~sample~)`
* 位宽一般为16、32，<b>简单理解为半个LRCK周期内(传输一个声道的数据)SCK周期数(可以传输的bit数)</b>。
* 位深指<b>在位宽内传输的实际有效bit数</b>。

[参考](https://zhuanlan.zhihu.com/p/678943329)

## 7. SPI

##### 概述
* Serial Peripheral Interface，串行同步全双工通信，广泛用于MCU与外设间高速数据传输。
* 速率远高于IIC，硬件简单，无需总线仲裁，本身不规定数据帧的长度，可支持多种数据帧格式、时钟配置和多从设备，便于扩展。
* SPI不像 I²C 有标准化的设备地址管理机制，需要主设备管理各从设备的片选。每个从设备需要一个独立的片选信号（CS），当从设备较多时，引脚资源占用较大。协议本身不提供应答机制或错误校验机制，通信错误检测需要由上层协议或应用实现。

##### 工作原理
* 

##### QSPI
​	

## 8. UART

##### 概述
* 是一种串行、异步的协议，可以用两根信号线组成全双工。
* 串行通信是指利用一条传输线将数据一位位地顺序传送，也可以用两个信号线组成全双工通信，如rs232。特点是通信线路简单，利用简单的线缆就可实现通信，降低成本，适用于远距离通信，但传输速度慢的应用场合。
* <u>异步通信以一个字符为传输单位，通信中两个字符间的时间间隔多少是不固定的，然而在同一个字符中的两个相邻位间的时间间隔是固定的</u>。通俗说是两个uart设备之间通信的时候不需要时钟线，这时候就需要在两个uart设备上指定相同的传输速率，以及空闲位、起始位、校验位、结束位，也就是遵循相同的协议。
* 数据传送速率用波特率来表示。
##### 传输格式
* `起始位 + 数据位 + 奇偶校验位 + 停止位`
* 起始位：协议规定空闲状态为高电平，通信前拉低信号线表示起始。
* 数据位：<b>低位先行</b>，位数可变，如ASCII码（7位），扩展BCD码（8位）。
* 奇偶校验位：时数据位中“1”的个数为奇数/偶数。
* 停止位：它是一个字符数据的结束标志。可以是1位、1.5位、2位的高电平。 由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备之间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟的机会。停止位个数越多，数据传输越稳定，但是数据传输速度也越慢。

​	
## CRC校验
  发送方：将发送数据视作多项式，如`10011 --> x^4^ + x^1^ + x^0^`；预定义生成多项式，通常用`G(x)`表示，which决定了CRC校验码的长度，常见有CRC-8、16和32等（这里8、16、32指校验码长度n-1，如CRC-8，生成多项式为9位，[8:0]）；再用二进制模2除法除以该生成多项式，余数即为CRC校验码，将校验码附加到发送数据后面构成完整数据。（二进制除法!=二进制模2除法）

  接收方：接收到的完整数据（数据+CRC）除以同样的生成多项式，若余数为0则表示数据在传输过程中未发生错误。

  <b>附加零操作</b>：设生成多项式n项，在模2除前在原始数据后面附件n-1个零。因为生成多项式为n项则余数（校验码）为n-1项，余下的n-1项没有参与计算，附加n-1个零之后，加上最后一位正好为n位，正好将最后一位也加入计算。不附加零可能会有误报和漏检。