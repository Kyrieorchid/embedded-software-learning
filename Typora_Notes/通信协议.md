# 通信协议

## 1. CAN

###### 基本特点

* CAN网络是***多主架构***，任何节点都可以在总线空闲时发送数据，而无需中央控制器。这种结构允许多个设备在总线上平等地通信。
* CAN协议不使用传统的地址方式进行通信，而是基于***消息ID***（Identifier）来标识数据。每个消息帧都包含一个唯一的ID，用于<u>决定消息的优先级和接收节点</u>，消息ID越低，优先级越高。
* 错误检测包括循环冗余校验（CRC）、帧检测、确认错误、位填充等。任何错误都会被检测并自动处理，确保数据传输的可靠性。
* 在同一网络中，所有单元必须设定成统一的通信速度。

###### 消息帧分类

* **数据帧（Data Frame）**

​	  用于传输实际的数据（发送数据）。数据帧的结构包括起始位、仲裁场、控制场、数据场、CRC场、ACK场和结束位。

* **远程帧（Remote Frame）**

​	  用于请求其他节点发送数据（接收数据），与数据帧类似，但没有数据字段，数据长度码以请求发送的数据长度表示。

* **错误帧（Error Frame）**

  当检测到通信错误时，节点会发送错误帧以通知总线上的其他节点。6位连续（主动错误显性、被动错误隐性）错误标志+8位连续隐性界定符。

* **过载帧（Overload Frame）**

  用于处理由于延迟或内部缓冲区未准备好而引起的超载情况。过载帧由过载标志（6个位的显性位）和过载界定符(8个位的隐性位)构成，连续6个显性位可以<u>打断其他节点继续发送帧</u>，从而防止过载。

###### 帧详细结构

* **起始位（Start of Frame, SOF）**：一个显性位，表示数据帧的开始。

* **仲裁段（Arbitration Field）**：包含报文ID，用于决定消息优先级。线与机制，逐位比较先显性电平的优先级高。

* **控制段（Control Field）**：包括标识符扩展位和数据长度码（DLC）。

* **数据段（Data Field）**：可包含0到8字节的数据，在CAN-FD中可扩展到64字节。**<u>*高位先行*</u>**

* **CRC段（CRC Field）**：用于错误检测的循环冗余校验码，15位CRC序列和1位分隔符。计算范围包括<u>帧起始、仲裁段、控制段和数据段</u>。

* **ACK段（ACK Field）**：包括Slot和分节符，接收节点用来确认成功接收到消息。发送单元发送隐性，接收到正常消息的节点发送显性。

* **结束位（End of Frame, EOF）**：7个隐性位，表示数据帧的结束。

* **帧间隔**：连续3个隐性位，用于分隔数据帧和遥控帧的帧。过载帧和错误帧前不能插入帧间隔。

###### CAN的工作原理

1. **仲裁机制（非破坏性制裁、线与机制）**：

- 当多个节点同时尝试在总线上发送数据时，它们会根据消息ID的优先级进行仲裁。每个节点<u>在发送数据的过程中不断监控总线上的信号</u>。如果某个节点发现自己发送的ID的某个位在总线上与期望的不符，它就会停止发送，因为另一个具有更高优先级的节点正在发送数据。这样，<u>只有优先级最高的节点可以成功发送其消息</u>。

2. **错误检测**：

- CAN协议通过多种方式进行错误检测，包括位监控、位填充、CRC校验、帧校验和确认检查。当检测到错误时，<u>发送错误帧来通知其他节点，并尝试重新发送数据</u>。错误状态分为主动错误状态，被动错误状态和总线关闭态3种状态，根据发送错误和接收错误计数值来决定进入何种状态。
- 位错误、填充错误、格式错误、ACK错误：在错误产生的那一位的下一位开始发送错误帧。
- CRC错误：紧随ACK界定符后的位发送错误帧。  

3. **消息过滤**：

- 每个节点可以<u>根据消息ID过滤</u>接收的数据，只处理相关的消息，减少不必要的数据处理。

***

[参考](https://zhuanlan.zhihu.com/p/162708070)

## 2. LIN

 * LIN（Local Interconnect Network）是CAN（Controller Area Network）的补充。

 * 单数据线串行通信，通常用UART接口通信（***接口*** & ***协议***），低成本、简单、低速。多用于车门、车窗、车灯等控制。

 * 主从架构：一个主节点和若干从节点（一般最多15个），主节点调度和控制通信，从节点被动响应主节点的命令。

 * 同步机制：通过同步字段（Sync Field）和标识符字段（Identifier Field）来实现节点的同步。

   <img src="https://pic2.zhimg.com/v2-99ab1663773aab1178888fc4d7165d3d_r.jpg" alt="img" style="zoom:50%;" />

   ***

   ##### 帧结构

   <img src="https://pic4.zhimg.com/v2-acabef5c62959abaccb9ea881b5c3887_r.jpg" alt="img" style="zoom:50%;" />

    1. **Break同步间隔字段**：用于指示帧的开始，由主节点发送，用于唤醒从节点并同步通信。Break段至少13位显性电平和至少1位隐性间隔符（总共14bit）。

    2. **Sync同步字段**：用于同步从节点的波特率，通常为0x55（01010101b）；主机时钟精度要高。

       ​	**Tips：字节域（Byte Field）**：1位显性起始位+8位data+1位隐性停止位（”显开隐走“），是一种标准的UART传输格式。在Lin的一帧中除Break段外都是以ByteField传输的，低位先行。

       <img src="https://pic3.zhimg.com/v2-10db3a69fec2fadf942c9fa6d17f259a_r.jpg" alt="img" style="zoom:50%;" />

       有：	`传输1位时间 = (第7位下降沿 - 起始位下降沿) / 8`

       即主节点位速率，从节点计算出用来同步自身速率。

       

    3. **Protected Identifier受保护ID字段（8位PID）**：包含帧的类别和目的地，包括6位帧ID和2位奇偶校验位。

       <img src="https://pic3.zhimg.com/v2-e3541718b5d77ff994552c06df0e55e6_r.jpg" alt="img" style="zoom:50%;" />

       帧ID取值范围0x00~0x3F，共64个，从机根据该ID做出反应（接收/发送/忽略）。校验位如下：

       <img src="https://pic1.zhimg.com/v2-d638af4335e6f7358708fd2f82c1391c_r.jpg" alt="img" style="zoom:50%;" />

       由于异或运算，PID段不会出现全0或全1，若从节点收到0xFF、0x00则传输错误。

       

    4. **数据字段**：包含实际传输的数据，长度为1到8字节（常用（2、4）8字节），两种数据类型：信号和诊断消息。Lin并没有规定数据长度的信息，需要提前设定。

    5. **校验字段**：用于错误检测，采用经典校验和（Checksum）算法。

   ***

​	[参考](https://www.zhihu.com/search?type=content&q=lin%E5%8D%8F%E8%AE%AE)



## 3. SENT

​	

## 4. ETH

​	

## 5. I2C

​	

## 6. I3C

​	

## 7. SPI

​	

## 8. UART

​	

