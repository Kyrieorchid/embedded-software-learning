# Chapter4 架构
1. 操作状态
    * 调试状态：处理器被暂停执行指令（调试器或触发断点）。
    * thumb状态：正常执行程序代码（thumb指令）。thumb状态下存在两种模式，由软件转换：
        ** 线程模式：执行普通app代码，可以在特权访问等级或非特权访问等级；
        ** 处理模式：执行ISR等异常处理，此时处理器一定处于特权访问等级。

2. 寄存器
    * 对于ARM架构，若处理内存中的数据，需要将其加载到寄存器处理，完毕后若有必要再写回内存，即“加载-存储结构”。
    * 寄存器组中共16个R0~R15：
    | Name     | 描述                                 | 备注                      |
    |:---------|:------------------------------------|:-------------------------|
    | R0~R7    | 通用目的寄存器                        | 低寄存器                 |
    | R8~R12   | 通用目的寄存器                        | 高寄存器                 |
    | R13      | MSP主栈指针 / PSP进程栈指针            | 分组寄存器（指向栈）      |
    | R14      | 链接寄存器                            | LR（Link Register）       |
    | R15      | 程序计数器                            | PC（Program Counter）     |
    * R13
    MSP在复位或处理模式时使用，<b>在复位时被初始化为存储器的第一个字</b>；PSP只能用于线程模式，一般使用OS时才会用到，将OS内核同应用层的栈隔离，未定义初始值。
    * R14
    在函数或子程序调用时保存返回地址，在异常处理时更新为异常返回。
    * R15
    <b>指令必须对齐到半字</b>。读PC返回当前指令地址加4（流水线特性和兼容原因）。
    * 特殊寄存器（状态、中断/异常屏蔽），读：`MRS <reg>, <special_reg>`，写：`MSR <special_reg>, <reg>`。
    * 浮点寄存器
    S0~S31，D0~D15。S均为32位寄存器，D为双精度，[S1:S0]组成D0，[S3:S2]组成D1]。

3. 异常和中断
    * NVIC:
        ** 支持脉冲触发、电平触发。
        ** 可嵌套，且抢占不会带来软件开销。
        ** 中断入口向量化，降低进中断时间。

    * <u>向量表</u>
        ** 异常编号1~255，其中1~15为系统异常，16~255为支持的240个中断输入。
        ** 向量表是存储器中的字数据数组，每个元素代表一个异常处理起始地址。vector table可以重定位（设置地址offset，由于统一编址，若加上一个SRAM的地址偏置就可以将表重定位到SRAM里），通过设置NVIC->SCB->VTOR控制。NVIC->SCB->VTOR默认为0，所以向量表位于地址0x0处。<u>例如复位为异常类型1，则复位向量的地址为1✖4(word)，即0x0000 0004，地址0x0000 0000存的是MSP初始值</u>。
        ** 异常向量字对齐，即4字节对齐，地址最低2位为0，但LSB表示异常是否在thumb状态下执行，由于Cortex-M只支持thumb，故所有向量LSB都为1。
    
    * <b>复位流程</b>
        在复位后处理器开始执行程序前，处理器先读出存储器的头两个字即<u>MSP初始值和Reset向量地址</u>分别赋给MSP和PC。<b>在复位的短时间内可能产生NMI或HardFault异常，压栈并进入异常处理前，处理器需要栈存储和MSP</b>。